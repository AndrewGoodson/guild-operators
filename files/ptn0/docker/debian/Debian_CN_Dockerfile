# FROM https://hydra.iohk.io/job/Cardano/cardano-node/cardano-node-linux/latest-finished
# Latest Genesis: https://hydra.iohk.io/job/Cardano/cardano-node/cardano-deployment/latest-finished

FROM debian

ARG DEBIAN_FRONTEND=noninteractive

ENV \
    ENV=/etc/profile \
    USER=guild \
    CNODE_HOME=/opt/cardano/cnode \
    PATH=/nix/var/nix/profiles/per-user/guild/profile/bin:/nix/var/nix/profiles/per-user/guild/profile/sbin:/opt/cardano/cnode/scripts:/bin:/sbin:/usr/bin:/usr/sbin \
    GIT_SSL_CAINFO=/etc/ssl/certs/ca-certificates.crt \
    NIX_SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt \
    NIX_PATH=/nix/var/nix/profiles/per-user/guild/channels

# PREREQ + DEBUG
RUN apt-get update && apt-get -y install curl apt-utils xz-utils netbase sudo && apt-get clean &&rm -rf /usr/bin/apt*

# SETUP USER
RUN adduser --disabled-password --gecos '' guild
RUN adduser guild sudo
RUN echo '%sudo ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

USER guild
WORKDIR /home/guild

# INSTALL NIX
RUN sudo curl -sL https://nixos.org/nix/install | sh \
    && sudo ln -s /nix/var/nix/profiles/per-user/etc/profile.d/nix.sh /etc/profile.d/ \
    && . /home/guild/.nix-profile/etc/profile.d/nix.sh 

# INSTALL DEPS  
RUN /nix/var/nix/profiles/per-user/guild/profile/bin/nix-env -i python3 systemd libsodium tmux jq bc ncurses libtool autoconf git wget gnupg \
    && /nix/var/nix/profiles/per-user/guild/profile/bin/nix-channel --update \
    && /nix/var/nix/profiles/per-user/guild/profile/bin/nix-env -u --always \
    && /nix/var/nix/profiles/per-user/guild/profile/bin/nix-collect-garbage -d

# GUILD SKAffold
RUN sudo mkdir -p $CNODE_HOME/files $CNODE_HOME/db $CNODE_HOME/logs $CNODE_HOME/scripts $CNODE_HOME/sockets $CNODE_HOME/priv \
    && sudo chown -R guild:guild $CNODE_HOME \
    && chmod -R 755 $CNODE_HOME 

# GUILD SCRIPTS
RUN cd && git clone --quiet https://github.com/cardano-community/guild-operators.git \
    && cp -rf ~/guild-operators/scripts/cnode-helper-scripts/* $CNODE_HOME/scripts \
    && cp -rf ~/guild-operators/files/ptn0/scripts/* $CNODE_HOME/scripts \
    && cp -rf ~/guild-operators/files/ptn0/files/* $CNODE_HOME/files \
    && rm -rf ~/guild-operators

# HYDRA BINS
RUN cd /usr/bin \
    && REDIRECT=$(curl -s https://hydra.iohk.io/job/Cardano/cardano-node/cardano-node-linux/latest-finished | grep "hydra.iohk.io/build" | cut -d "\"" -f 2) \
    && DOWNLATEST=$(curl -s $REDIRECT | grep "tar.gz" | head -n 1 |  cut -d "\"" -f 2) \
    && sudo curl -o cardano-node-latest-linux.tar.gz $DOWNLATEST \
    && sudo tar xzvf cardano-node-latest-linux.tar.gz \
    && sudo rm cardano-node-latest-linux.tar.gz \
    && sudo mv configuration $CNODE_HOME/files

# ENTRY SCRIPT
ADD https://raw.githubusercontent.com/cardano-community/guild-operators/docker/files/ptn0/docker/CN_entrypoint.sh ./
RUN sudo chown -R guild:guild /home/guild/CN_entrypoint.sh \
    && sudo chown -R guild:guild $CNODE_HOME/files/* \
    && chmod +x /home/guild/CN_entrypoint.sh
    
# CMD /bin/bash
ENTRYPOINT ["./CN_entrypoint.sh"]
