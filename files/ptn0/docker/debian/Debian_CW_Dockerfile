FROM debian

ENV \
CNODE_HOME=/opt/cardano/cnode \
CNODE_PORT=9000 \
DEBIAN_FRONTEND=noninteractive \
LANG=C.UTF-8 \
ENV=/etc/profile \
USER=root \
PATH=$CNODE_HOME/scripts:~/.cabal/bin:~/.ghcup/bin:/bin:/sbin:/usr/bin:/usr/sbin:$PATH 

RUN set -x \
  && apt update \
  && apt install -y wget \
  && cd / \
  && wget https://raw.githubusercontent.com/cardano-community/guild-operators/master/files/ptn0/scripts/prereqs.sh \
  && wget https://raw.githubusercontent.com/cardano-community/guild-operators/docker/files/ptn0/docker/CW_entrypoint.sh \
  && chmod +x /CW_entrypoint.sh && cp /CW_entrypoint.sh /bin/ \
  && cat prereqs.sh | sed 's/SUDO="Y";/SUDO="N";/g' > /tmp/prereqs.sh \
  && export BOOTSTRAP_HASKELL_NO_UPGRADE=1 \
  && bash /tmp/prereqs.sh \
  && bash ~/.bashrc \
  && export PATH=$CNODE_HOME/scripts:/root/.cabal/bin:/root/.ghcup/bin:/bin:/sbin:/usr/bin:/usr/sbin:$PATH \
  && git clone https://github.com/input-output-hk/cardano-wallet.git \
  && cd cardano-wallet \
  && bash /opt/cardano/cnode/scripts/stack-build.sh \
  && cd - && apt remove -y build-essential pkg-config libffi-dev libgmp-dev libssl-dev libtinfo-dev libsystemd-dev zlib1g-dev npm yarn make g++ libncursesw5 git tmux && apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* cardano-wallet \
  && echo "Done!";

EXPOSE 8090

ENTRYPOINT ["bash"]
CMD ["/CW_entrypoint.sh"]
